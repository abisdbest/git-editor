<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="../style.css">
<title>GitHub Repository Files</title>
</head>
<body>
  <h1>GitHub Repository Files</h1>
  <!-- Place this script before other CSS and JS includes in the HEAD. Use this code to temporarily hide the file explorer list if Javascript is enabled. When list is loaded then display it. 
Note: Alternative is to use Modernizr to detect JS and appy "js" and "no-js" CSS selectors -->
<script type="text/javascript">
	document.write('<style type="text/css">.menu-tree-preloader { display:block; } .menu-tree { display:none; }</style>');
</script>

<h1>jQuery File Explorer 1</h1>
<div class="menu-tree-container">
<div class="menu-tree-preloader"><img src="../Iphone-spinner-2.gif"></div>
<div class="menu-tree">
<ul id="files">
  <!-- Files will be dynamically added here -->
</ul>
</div>
</div>

  <script>
    async function fetchRepositoryFiles(username, repo, path) {
      try {
        const response = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${path}#classroom.google.com`);
        const files = await response.json();
        return files;
      } catch (error) {
        console.error('Error fetching repository files:', error);
        return [];
      }
    }

    async function displayRepositoryFiles(username, repo, path = '') {
      const filesContainer = document.getElementById('files');
      filesContainer.innerHTML = ''; // Clear previous data

      const files = await fetchRepositoryFiles(username, repo, path);

      files.forEach(file => {
        const itemElement = document.createElement('li');
        if (file.type == "dir") {
          itemElement.innerHTML = `${file.name}<ul></ul>`;
          itemElement.addEventListener('click', async () => {
            const nestedFiles = await fetchRepositoryFiles(username, repo, `${path}${file.name}/`);
            displayRepositoryFiles(username, repo, `${path}${file.name}/`);
            const nestedList = itemElement.querySelector('ul');
            nestedFiles.forEach(nestedFile => {
              const nestedItemElement = document.createElement('li');
              nestedItemElement.innerHTML = `<li>${nestedFile.name}</li></li><a href="../edit/?file=${nestedFile.name}&repo=${repo}" target="_blank">Edit ${nestedFile.name}</a></li>`;
              nestedList.appendChild(nestedItemElement);
            });
          });
        } else {
          itemElement.innerHTML = `<li><a href="../edit/?file=${file.name}&repo=${repo}" target="_blank">${file.name}</a>`;
        }
        filesContainer.appendChild(itemElement);
      });
    }

    function getParams() {
      const urlParams = new URLSearchParams(window.location.search);
      const repo = urlParams.get('repo');
      const username = urlParams.get('username');
      return { username, repo };
    }

    function init() {
      const { username, repo } = getParams();
      if (username && repo) {
        displayRepositoryFiles(username, repo);
      } else {
        alert("Invalid parameters. Please provide both username and repository name.");
      }
    }

    init();
  </script>
  <script src="../script.js"></script>
</body>
</html>
